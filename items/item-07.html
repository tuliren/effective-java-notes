
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Item 07: memory leak Â· GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="item-08.html" />
    
    
    <link rel="prev" href="item-06.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Contents
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" >
            
                <span>
            
                    
                    Chapter 02
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="item-01.html">
            
                <a href="item-01.html">
            
                    
                    Item 01: static factory
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="item-02.html">
            
                <a href="item-02.html">
            
                    
                    Item 02: builder
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.3" data-path="item-03.html">
            
                <a href="item-03.html">
            
                    
                    Item 03: enum singleton
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.4" data-path="item-04.html">
            
                <a href="item-04.html">
            
                    
                    Item 04: private constructor
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.5" data-path="item-05.html">
            
                <a href="item-05.html">
            
                    
                    Item 05: dependency injection
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.6" data-path="item-06.html">
            
                <a href="item-06.html">
            
                    
                    Item 06: prefer primitives
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.2.7" data-path="item-07.html">
            
                <a href="item-07.html">
            
                    
                    Item 07: memory leak
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.8" data-path="item-08.html">
            
                <a href="item-08.html">
            
                    
                    Item 08: no finalizer
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.9" data-path="item-09.html">
            
                <a href="item-09.html">
            
                    
                    Item 09: try with resource
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Item 07: memory leak</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="item-07-eliminate-obsolete-object-references">Item 07: Eliminate obsolete object references</h1>
<h2 id="source-of-memory-leak">Source of memory leak</h2>
<h3 id="obsolete-references">Obsolete references</h3>
<p>Memory leak</p>
<pre><code class="lang-java"><span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">pop</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">if</span> (size == <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> EmptyStackException();
  }

  <span class="hljs-comment">// memory leak</span>
  <span class="hljs-keyword">return</span> elements[--size];
}
</code></pre>
<p>Fix</p>
<pre><code class="lang-java"><span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">pop</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">if</span> (size == <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> EmptyStackException();
  }

  Object result = elements[--size];
  <span class="hljs-comment">// eliminate obsolete object reference</span>
  elements[size] = <span class="hljs-keyword">null</span>;
  <span class="hljs-keyword">return</span> result;
}
</code></pre>
<ul>
<li>The fix is to null out references once they become obsolete.</li>
<li>Nulling out object references should be the exception rather than the norm.</li>
<li>The best way to eliminate an obsolete reference is to let the variable that contained the reference fall out of scope.</li>
</ul>
<h3 id="cache">Cache</h3>
<ul>
<li>Use <a href="https://docs.oracle.com/javase/8/docs/api/java/util/WeakHashMap.html" target="_blank"><code>WeakHashMap</code></a> whose entries will be removed automatically after they become obsolete. Use this approach only when the desired lifetime of cache entries is determined by external references to the key, not the value.</li>
<li>Cache should occasionally be cleansed of entries that have fallen into disuse.</li>
</ul>
<h3 id="listerners-and-other-callbacks">Listerners and other callbacks</h3>
<ul>
<li>Registered callbacks are not deregistered and accumulate in memory.</li>
<li>Store only week references to callbacks, for example, by storing them only as keys in a <code>WeakHashMap</code>.</li>
</ul>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="item-06.html" class="navigation navigation-prev " aria-label="Previous page: Item 06: prefer primitives">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="item-08.html" class="navigation navigation-next " aria-label="Next page: Item 08: no finalizer">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Item 07: memory leak","level":"1.2.7","depth":2,"next":{"title":"Item 08: no finalizer","level":"1.2.8","depth":2,"path":"items/item-08.md","ref":"items/item-08.md","articles":[]},"previous":{"title":"Item 06: prefer primitives","level":"1.2.6","depth":2,"path":"items/item-06.md","ref":"items/item-06.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":[],"pluginsConfig":{"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"items/item-07.md","mtime":"2018-11-19T05:27:41.577Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2018-11-19T09:05:06.393Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

